#!/usr/bin/env node
var program = require('commander'),
    path    = require('path'),
    package = require('../package.json'),
    amqp    = require('amqplib'),
    Q       = require('q'),
    configFile = 'config.json';

program
  .version(package.version)
  .usage('[options] config_file')
  .parse(process.argv);

switch(true) {
  case program.args.length == 1:
    configFile = program.args[0];
    break;
  case program.args.length > 1:
    program.help();
    break;
  default:
    //No config leaves us with defaults
}

process.on('SIGINT', function () {
  process.exit();
});

process.on('uncaughtException', function (e) {
  console.error(e.stack);
  process.exit();
});

var Radiodan = require(__dirname+'/../lib/radiodan'),
    radios = [];

try {
  var config = require(path.relative(__dirname, configFile));
} catch(err) {
  program.help();
  process.exit(1);
}

var radios = config.radios.map(function(radio, i) {
  var radioConfig = config.paths;
  radioConfig.name = radio.name;

  var radiodan = Radiodan.create(config.paths, radio).start();

  return radiodan;
})

var client = require('../lib/messaging-client').create();

client.createAndBindToExchange({
  queueName: 'commands',
  exchangeName: 'radiodan',
  topicsKey: 'commands.*'
});

client.on('commands.play', doSomething);
client.on('message', logMessage);

function logMessage(data) {
  console.log('new message: ', data.fields.routingKey);
  data.ack();
}

function doSomething(data) {
  var command = data.content;
  console.log('command', command);
  switch(command.player) {
    case 'random':
      var radio = radios[command.playerId];
      radio.sendCommands([
        ['clear'], ['add', ['iTunes']], ['random', ['1']], ['play']
      ]).then(function() { console.log("Played Randomly")});
      break;
    default:
      console.log("Don't know what to do with" + command.player);
  }

  data.ack();
}
