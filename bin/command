#!/usr/bin/env node
var amqp    = require('amqplib');

var waitForConnection = amqp.connect('amqp://localhost');

var channel;

var command = JSON.stringify( {playerId: 1, player: 'random'} );

waitForConnection.then(function (connection) {
  var waitForChannel = connection.createChannel();
  waitForChannel.then(function (ch) {
    console.log('channel created', ch);
    channel = ch;
    var waitForExchange = channel.assertExchange('radiodan', 'topic');
    waitForExchange.then(function () {
      console.log('exchange asserted');
      channel.publish('radiodan', 'commands.play', new Buffer(command));
      console.log('published');
    }).fail(function () {
      console.error('error')
    });
  });
});
